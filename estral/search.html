<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="./favicon.png"/>
    <title>Search</title>
    <link rel="stylesheet" href="./global.css"/>
    <script src="./components.js"></script>
</head>
<body>
<header>
    <header-content></header-content>
</header>
<main>
    <section aria-labelledby="search-title" id="search-container">
        <h1 id="search-title">Explore</h1>
        <p id="subtitle"></p>
        <form>
            <input type="search" placeholder="search" name="search" id="search">
            <button>Search</button>
        </form>
    </section>
    <section aria-label="Results" id="results-container">
        <ul id="results"></ul>
        <template id="result-template">
            <li>
                <a class="result-link">
                    <p class="result-title" style="font-size: 1.1em;"></p>
                    <p class="result-username"></p>
                    <div class="result-img">
                        <img />
                    </div>
                </a>
            </li>
        </template>
    </section>
    <script type="module">
        import { getLocalImageData } from "./auth.js";
        
        let data = getLocalImageData();
        if (data.length > 0) {
            // calculate size
            const sizeb = data.map(item => item.base64url.length).reduce((cum, cur) => cum + cur, 0) * 2; // utf16
            
            let size;
            if (sizeb < 1000) size = `${sizeb}B`;
            else if (sizeb < 1_000_000) size = `${Math.round(sizeb / 1000)}kB`;
            else size = `${Math.round(sizeb / 1_000_000)}MB`;
            
            document.getElementById("subtitle").innerText = `Total size of images: ${size}`;

        } else {
            document.getElementById("subtitle").innerText = " (No images uploaded. Content is autogenerated. Upload some images to see them here)";
            data = [
                { title: "abstract squares", base64url: "./result1.png", username: "<autogenerated>", description: "", id: "<autogenerated>"  },
                { title: "abstract waves",   base64url: "./result2.png", username: "<autogenerated>", description: "", id: "<autogenerated>"  },
                { title: "abstract star",    base64url: "./result3.png", username: "<autogenerated>", description: "", id: "<autogenerated>"  },
                { title: "french flag",      base64url: "./result4.png", username: "<autogenerated>", description: "", id: "<autogenerated>"  },
                { title: "le sserafim",      base64url: "./result5.svg", username: "<autogenerated>", description: "", id: "<autogenerated>"  },
            ];
        }
        
        const search = new URLSearchParams(window.location.search).get("search")?.toLowerCase();
        if (search) {
            document.getElementById("search").value = search;
            
            data = data.filter(item => item.title.toLowerCase().includes(search));
        }

        const list = document.getElementById("results");
        const template = document.getElementById("result-template");
        for (let i = 0; i < data.length; i++) {
            const item = data[i];
            const node = template.content.cloneNode(true);
            node.querySelector(".result-link").href = "./item.html?id=" + encodeURIComponent(item.id);
            node.querySelector(".result-title").innerText = item.title;
            node.querySelector(".result-username").innerText = item.username;
            node.querySelector(".result-img > img").src = item.base64url;
            node.querySelector(".result-img > img").alt = item.title;
            list.appendChild(node);
        }
    </script>
</main>
<style>
    main {
        margin-top: 24px;
        width: 95%;
        align-self: center;
        display: flex;
        flex-direction: column;
        /*align-items: center;*/
    }
    
    #search-container {
        & form {
            display: flex;
            gap: 0.75em;
        }
        & input {
            font-size: 1em;
            padding: 4px;
        }
        & button {
            padding: 4px;
        }
    }
    
    #results {
        margin-top: 12px;
        display: flex; 
        /*justify-content: space-evenly;*/
        flex-flow: wrap;
        gap: 2em;

        & > li {
            list-style: none;
        }
    }
    .result-link {
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        text-decoration-line: none;
        border: 1px solid rgba(200, 200, 200, 0.1);
        border-radius: 4px;
        padding: 6px;
        max-width: 300px;
        word-wrap: anywhere;
        
        &:is(:hover, :focus-visible) {
            border-color: black;
        }
        
        & img {
            max-width: 100%;
        }
    }
    
    @media screen and (width <= 800px) {
        main {
            align-items: center;
        }
        #results {
            flex-direction: column;
            align-items: center;
            flex-wrap: nowrap;
        }
    }
</style>
</body>
</html>